name: Deploy to Netlify (Hugo)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.121.1'
          extended: true

      - name: Build site
        run: |
          chmod +x build_menu.sh
          ./build_menu.sh

      - name: Zip public directory
        run: |
          cd public
          zip -r ../site.zip .

      - name: Deploy to Netlify via API
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_NAME: ${{ secrets.NETLIFY_SITE_NAME }}
        run: |
          if [ -z "$NETLIFY_AUTH_TOKEN" ] || [ -z "$NETLIFY_SITE_NAME" ]; then
            echo "NETLIFY_AUTH_TOKEN or NETLIFY_SITE_NAME secrets are missing."
            exit 1
          fi

          response=$(curl -s -H "Content-Type: application/zip" \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            --data-binary "@site.zip" \
            https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_NAME}/deploys)

          echo "Netlify response: $response"

